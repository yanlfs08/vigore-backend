generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TipoPermissao {
  ADMIN
  RECEPCAO
  PRE_ATENDIMENTO
  MEDICO
}

model Usuario {
  id              Int           @id @default(autoincrement())
  nome_completo   String
  email           String        @unique
  senha_hash      String
  tipo_permissao  TipoPermissao @default(RECEPCAO)
  crm             String?       // Apenas para médicos
  telefone        String?
  ativo           Boolean       @default(true)

  data_criacao    DateTime      @default(now())
  data_atualizacao DateTime     @updatedAt

  mensagensEnviadas   Mensagem[] @relation("Remetente")
  mensagensRecebidas  Mensagem[] @relation("Destinatario")

  agendamentos    Agendamento[]
  documentos      Documento[]

  agendaPadrao    AgendaPadrao[]
  bloqueios       BloqueioAgenda[]


  @@map("usuarios")
}

enum CanalCaptacao {
  INDICACAO
  MIDIA_SOCIAL
  OUTROS
}

enum StatusPaciente {
  ATIVO
  INATIVO
}

model Paciente {
  id                     Int            @id @default(autoincrement())
  nome_completo          String
  cpf                    String?        @unique
  data_nascimento        DateTime?      @db.Date
  telefone_principal     String
  telefone_secundario    String?
  email                  String?
  endereco               String?

  data_primeira_consulta DateTime       @db.Date
  canal_captacao         CanalCaptacao?
  status                 StatusPaciente @default(ATIVO)
  observacoes_gerais     String?        @db.Text

  data_criacao           DateTime       @default(now())
  data_atualizacao       DateTime       @updatedAt
  agendamentos           Agendamento[]
  documentos              Documento[]

  @@map("pacientes")
}

enum StatusAgendamento {
  PENDENTE
  CONFIRMADO
  CHEGOU
  EM_ATENDIMENTO
  CONCLUIDO
  CANCELADO
  NAO_COMPARECEU
}

enum TipoConsulta {
  PRIMEIRA_CONSULTA
  RETORNO
}

model Procedimento {
  id                    Int      @id @default(autoincrement())
  nome                  String   @unique
  descricao             String?  @db.Text
  duracao_media_minutos Int?
  valor                 Decimal? @db.Decimal(10, 2)
  ativo                 Boolean  @default(true)

  data_criacao          DateTime @default(now())
  data_atualizacao      DateTime @updatedAt

  // Relações
  agendamentos Agendamento[]

  @@map("procedimentos")
}

model Agendamento {
  id              Int               @id @default(autoincrement())

  // Chaves Estrangeiras
  id_paciente     Int
  paciente        Paciente          @relation(fields: [id_paciente], references: [id])

  id_medico       Int
  medico          Usuario           @relation(fields: [id_medico], references: [id])

  id_procedimento_principal Int?
  procedimento    Procedimento?     @relation(fields: [id_procedimento_principal], references: [id])

  data_hora_inicio   DateTime
  data_hora_fim      DateTime?
  motivo_consulta    String?        @db.Text

  status_agendamento StatusAgendamento @default(PENDENTE)
  tipo_consulta      TipoConsulta?

  data_criacao       DateTime       @default(now())
  data_atualizacao   DateTime       @updatedAt

  @@map("agendamentos")
}

enum TipoDocumento {
  ATESTADO_MEDICO
  ATESTADO_COMPARECIMENTO
  PEDIDO_EXAME
  RECEITA
}

model Documento {
  id              Int             @id @default(autoincrement())

  id_paciente     Int
  paciente        Paciente        @relation(fields: [id_paciente], references: [id])

  id_medico       Int
  medico          Usuario         @relation(fields: [id_medico], references: [id])

  tipo_documento  TipoDocumento

  // O texto final gerado (HTML ou Markdown)
  conteudo_gerado String          @db.Text

  // Dados variáveis em JSON (ex: lista de remédios, dias de repouso) [cite: 61]
  dados_especificos_json Json?

  data_geracao    DateTime         @default(now())

  @@map("documentos")
}

model ModeloDocumento {
  id                Int           @id @default(autoincrement())
  nome_modelo       String        @unique // Ex: "Atestado Padrão", "Receita Simples"
  tipo_documento    TipoDocumento
  conteudo_template String        @db.Text

  // Ex: Lista padrão de exames para um checkup [cite: 62]
  dados_padrao_json Json?

  ativo             Boolean       @default(true)
  data_criacao      DateTime      @default(now())
  data_atualizacao  DateTime      @updatedAt

  @@map("modelos_documentos")
}

model Mensagem {
  id          Int      @id @default(autoincrement())
  conteudo    String   @db.Text
  lida        Boolean  @default(false)

  remetenteId Int
  remetente   Usuario  @relation("Remetente", fields: [remetenteId], references: [id])

  destinatarioId Int
  destinatario   Usuario @relation("Destinatario", fields: [destinatarioId], references: [id])

  data_envio  DateTime @default(now())

  @@map("mensagens")
}

model AgendaPadrao {
  id              Int      @id @default(autoincrement())

  id_medico       Int
  medico          Usuario  @relation(fields: [id_medico], references: [id])

  dia_semana      Int      // 0 a 6
  horario_inicio  String   // Ex: "08:00"
  horario_fim     String   // Ex: "18:00"

  // Se quiser definir intervalo de almoço fixo, poderia adicionar aqui,
  // mas vamos manter simples por enquanto.

  @@map("agendas_padrao")
}

model BloqueioAgenda {
  id              Int      @id @default(autoincrement())

  id_medico       Int
  medico          Usuario  @relation(fields: [id_medico], references: [id])

  data_inicio     DateTime // Ex: 2024-12-25 00:00
  data_fim        DateTime // Ex: 2024-12-25 23:59
  motivo          String?  // Ex: "Natal", "Congresso", "Folga"

  data_criacao    DateTime @default(now())

  @@map("bloqueios_agenda")
}
